<div class="card">
  <p-toolbar class="mb-12">
    <ng-template #start>
      <p-button label="New" icon="pi pi-plus" severity="secondary" class="mr-2" (onClick)="openNew()" />
    </ng-template>
  </p-toolbar>

  <ng-container *ngIf="locations.length > 0; else noData">
    <p-table
      #dt
      [value]="locations"
      [rows]="10"
      [paginator]="true"
      [globalFilterFields]="['locationName', 'district', 'division']"
      [tableStyle]="{ 'min-width': '75rem' }"
      [rowHover]="true"
      dataKey="id"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} locations"
      [showCurrentPageReport]="true"
      [rowsPerPageOptions]="[10, 20, 30]"
    >
      <ng-template #caption>
        <div class="flex items-center justify-between">
          <h5 class="m-0">Manage Store Locations</h5>
          <p-iconfield>
            <p-inputicon class="pi pi-search" />
            <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Search..." />
          </p-iconfield>
        </div>
      </ng-template>

      <ng-template #header>
        <tr>
          <th pSortableColumn="locationName" style="min-width: 16rem">
            <span class="flex items-center gap-2">Name <p-sortIcon field="locationName" /></span>
          </th>
          <th pSortableColumn="locationTypeName" style="min-width: 14rem">
            <span class="flex items-center gap-2">Type <p-sortIcon field="locationTypeName" /></span>
          </th>
          <th pSortableColumn="district" style="min-width: 12rem">
            <span class="flex items-center gap-2">District <p-sortIcon field="district" /></span>
          </th>
          <th pSortableColumn="division" style="min-width: 12rem">
            <span class="flex items-center gap-2">Division <p-sortIcon field="division" /></span>
          </th>
          <th style="min-width: 8rem">Image</th>
          <th pSortableColumn="phone" style="min-width: 12rem">
            <span class="flex items-center gap-2">Phone <p-sortIcon field="phone" /></span>
          </th>
          <th pSortableColumn="email" style="min-width: 14rem">
            <span class="flex items-center gap-2">Email <p-sortIcon field="email" /></span>
          </th>
          <th style="min-width: 10rem"></th>
        </tr>
      </ng-template>

      <ng-template #body let-location>
        <tr>
          <td>{{ location.locationName }}</td>
          <td>{{ location.locationTypeName }}</td>
          <td>{{ location.district }}</td>
          <td>{{ location.division }}</td>
          <td>
            <img
              *ngIf="location.imagePath"
              [src]="location.imagePath"
              [alt]="location.locationName"
              style="width: 48px"
              class="rounded"
            />
          </td>
          <td>{{ location.phone }}</td>
          <td>{{ location.email }}</td>
          <td>
            <p-button icon="pi pi-pencil" class="mr-2" [rounded]="true" [outlined]="true" (click)="editLocation(location)" />
            <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [outlined]="true" (click)="deleteLocation(location)" />
          </td>
        </tr>
      </ng-template>
    </p-table>
  </ng-container>

  <ng-template #noData>
    <div class="p-5 text-center text-gray-500">
      <i class="pi pi-folder-open text-3xl mb-3"></i>
      <p class="text-lg font-semibold">No store locations found</p>
    </div>
  </ng-template>
</div>

<!-- Create/Edit Dialog -->
<p-dialog
  [header]="isEditMode ? 'Edit Store Location' : 'Create Store Location'"
  [(visible)]="showDialog"
  [modal]="true"
  [closable]="false"
  [style]="{ width: '600px' }"
>
  <ng-template pTemplate="default">
    <form [formGroup]="form" (ngSubmit)="submit()" class="flex flex-col gap-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="locationName" class="block font-bold mb-2">Location Name</label>
          <input class="w-full" id="locationName" type="text" pInputText formControlName="locationName" />
          @if (form.controls['locationName'].invalid && form.controls['locationName'].touched) {
            <small class="text-red-500">Location Name is required.</small>
          }
        </div>

        <div>
          <label for="locationTypeId" class="block font-bold mb-2">Location Type</label>
          <p-select
            inputId="locationTypeId"
            formControlName="locationTypeId"
            [options]="locationTypeOptions"
            optionLabel="label"
            optionValue="value"
            placeholder="Select Type"
            fluid
            filter
          />
          @if (form.controls['locationTypeId'].invalid && form.controls['locationTypeId'].touched) {
            <small class="text-red-500">Location Type is required.</small>
          }
        </div>

        <div>
          <label for="addressLine1" class="block font-bold mb-2">Address Line 1</label>
          <input class="w-full" id="addressLine1" type="text" pInputText formControlName="addressLine1" />
          @if (form.controls['addressLine1'].invalid && form.controls['addressLine1'].touched) {
            <small class="text-red-500">Address Line 1 is required.</small>
          }
        </div>

        <div>
          <label for="addressLine2" class="block font-bold mb-2">Address Line 2</label>
          <input class="w-full" id="addressLine2" type="text" pInputText formControlName="addressLine2" />
        </div>

        <!-- Division Dropdown -->
        <div>
        <label for="division" class="block font-bold mb-2">Division</label>
        <p-select
            inputId="division"
            formControlName="division"
            [options]="divisionOptions"
            optionLabel="label"
            optionValue="value"
            placeholder="Select Division"
            fluid
            filter
        />
        @if (form.controls['division'].invalid && form.controls['division'].touched) {
            <small class="text-red-500">Division is required.</small>
        }
        </div>

        <!-- District Dropdown -->
        <div>
        <label for="district" class="block font-bold mb-2">District</label>
        <p-select
            inputId="district"
            formControlName="district"
            [options]="filteredDistrictsOption"
            optionLabel="label"
            optionValue="value"
            placeholder="Select District"
            fluid
            filter
        />
        @if (form.controls['district'].invalid && form.controls['district'].touched) {
            <small class="text-red-500">District is required.</small>
        }
        </div>

        <div>
          <label for="phone" class="block font-bold mb-2">Phone</label>
          <input class="w-full" id="phone" type="text" pInputText formControlName="phone" />
          @if (form.controls['phone'].invalid && form.controls['phone'].touched) {
            <small class="text-red-500">Valid phone number is required.</small>
          }
        </div>

        <div>
          <label for="email" class="block font-bold mb-2">Email</label>
          <input class="w-full" id="email" type="email" pInputText formControlName="email" />
          @if (form.controls['email'].invalid && form.controls['email'].touched) {
            <small class="text-red-500">Valid email is required.</small>
          }
        </div>

        <div>
          <label for="googleMap" class="block font-bold mb-2">Google Map Link</label>
          <input class="w-full" id="googleMap" type="text" pInputText formControlName="googleMap" />
          @if (form.controls['googleMap'].invalid && form.controls['googleMap'].touched) {
                <small class="text-red-500">Please enter a valid URL (http, https, or ftp).</small>
            }
        </div>
      </div>

      <div>
        <label for="image" class="block font-bold mb-2">Location Image</label>
        <p-fileUpload
          name="image"
          customUpload
          [auto]="true"
          (uploadHandler)="onImageUpload($event)"
          accept="image/*"
        />
      </div>
    </form>
  </ng-template>


  <ng-template pTemplate="footer">
    <p-button label="Cancel" severity="secondary" (click)="closeDialog()" />
    <p-button
      [label]="isEditMode ? 'Update' : 'Create'"
      (onClick)="submit()"
      [disabled]="form.invalid"
    />
  </ng-template>
</p-dialog>
